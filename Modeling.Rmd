---
title: "Modeling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(modelr)
library(broom)
doParallel::registerDoParallel()
```

```{r}
df_all_only_total_na <- read_csv("./data/processed/combined_total_na.csv")
df_all_only_total <- read_csv("./data/processed/combined_total.csv")

df_all_only_enteric_na <- read_csv("./data/processed/combined_enteric.csv")
df_all_only_enteric <- read_csv("./data/processed/combined_enteric.csv")
df_livestock_patterns <- read_csv("./data/processed/df_livestock_patterns.csv")
```

```{r}
df_all_only_total <-
  df_all_only_total_na %>%
<<<<<<< HEAD
  # filter(Area == c("United States of America")) %>%
  # select_if(~ !any(is.na(.))) %>%
  select_if(~ !is.logical(.)) %>%
  # filter(Year >= 1990) %>%
  replace(is.na(.), 0) %>%
  select(contains("CO2"), Year, Area, contains("Yield"))
  # select(contains("CO2"), Year, Area, contains("Stock"))
  # select(contains("CO2"), Year, Area, !contains("Stock"))
  # select(contains("CO2"), Year, Area, contains("Area"))
=======
  filter(Area == c("United States of America")) %>%
  select_if(~ !any(is.na(.))) %>%
  filter(Year >= 1990)
  # replace(is.na(.), 0) %>%
  # select()
>>>>>>> 17fc57e2744864a149a49d9a098a44b12bd754af
# -contains("Area harvested"), -contains("Production") contains("CO2"), Year, Area, contains("Yield") , -contains("Stocks")
# df_all_only_total <-
#   df_livestock_patterns

df_all_only_total

# df_all_only_enteric <-
  # df_all_only_enteric %>%
  # filter(Area == "United States of America")
#   df_all_only_enteric_na %>%
#   filter(Area == "United States of America") %>%
#   select_if(~ !any(is.na(.)))
# df_all_only_enteric
```


```{r}
emissions_split = initial_split(df_all_only_total, prop = 0.8)
emissions_train = training(emissions_split)
emissions_test = testing(emissions_split)
emissions_train
emissions_test
```

```{r}
emissions_rec <-
  # recipe(`Enteric Fermentation|CO2` ~ ., data = emissions_train) %>%
  recipe(`Agriculture total|CO2` ~ ., data = emissions_train) %>%
  step_rm(Year, Area) %>%
  step_zv(all_numeric(), -all_outcomes()) %>%
  step_normalize(all_numeric(), -all_outcomes())

emissions_prep <-
  emissions_rec %>%
  prep()
```

```{r}
lasso_spec <-
  linear_reg(penalty = 0.1, mixture=1) %>%
  set_engine("glmnet")

wf <-
  workflow() %>%
  add_recipe(emissions_rec)

lasso_fit <-
  wf %>%
  add_model(lasso_spec) %>%
  fit(data = emissions_train)

df_coeff <-
  lasso_fit %>%
  pull_workflow_fit() %>%
  tidy()
df_coeff
```

```{r}
df_coeff %>%
  arrange(desc(estimate)) %>%
  filter(term != "(Intercept)")
```

```{r}
df_coeff %>% 
  mutate(
    term = fct_reorder(term, estimate)
  ) %>% 
  arrange(desc(abs(estimate))) %>% 
  filter(term != "(Intercept)") %>%
  head(30) %>%
  filter(estimate > 0) %>%
  ggplot(aes(
      x = estimate,
      y = term
    )) +
  geom_col()
```

```{r}
emissions_boot <- bootstraps(emissions_train, 25)

tune_spec <-
  linear_reg(penalty = tune(), mixture = 1) %>%
  set_engine("glmnet")

lambda_grid <- grid_regular(penalty(), levels = 50)
```

```{r}
lasso_grid <-
  tune_grid(
    wf %>% add_model(tune_spec),
    resamples = emissions_boot,
    grid = lambda_grid
  )
```

```{r}
lasso_grid %>%
  collect_metrics() %>%
  ggplot(aes(penalty, mean, color = .metric)) +
  geom_errorbar(aes(
    ymin = mean - std_err,
    ymax = mean + std_err
  ),
  alpha = 0.5
  ) +
  geom_line(size = 1.5) +
  facet_wrap(~.metric, scales = "free", nrow = 2) +
  scale_x_log10() +
  theme(legend.position = "none")
```

```{r}
lowest_rmse <- lasso_grid %>%
  select_best("rmse")

final_lasso <- finalize_workflow(
  wf %>% add_model(tune_spec),
  lowest_rmse
)
```

```{r}
last_fit(
  final_lasso,
  emissions_split
) %>%
  collect_metrics()
```


 All countries, all years, only yield: 0.607
 All countries, all years, only yield, no logical: 0.587
 All countries, all years, only area, no logical: 0.977
 All countries, all years, only crops, no logical: 0.998
 All countries, all years, only livestock: 0.975
 All countries, all years, all inputs: 0.985
 All countries, filtered years, only yield: 0.684
*All countries, filtered years, only yield, no logical: 0.271*
 All countries, filtered years, only livestock: 0.979
 All countries, filtered years, all inputs: 0.999

















  








